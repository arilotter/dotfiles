#!/bin/bash

# API key from Alan@imgur.com, see imgurbash.sh
KEY="b3625162d3418ac51a9ee805b1840452"

die () {
  echo "$1" >&2
  exit 1
}

if [ $# -eq 0 ]; then
  #assume stdin??
  set -- "-" "${@:2}" #jesus christ this is retarded
fi

# Upload every file given as argument
for IMG in "$@"
do
  # A more verbose version of `curl -s [...] | jshon -Q -e rsp -e image -e original_image -u`

  RESP="`curl -sS -F key=$KEY -H 'Expect: ' -F "image=@$IMG" http://imgur.com/api/upload.json 2>&1`"
  [ $? -ne 0 ] && die "$IMG: $RESP"

  URL=`echo "$RESP" | jshon -Q -e rsp -e image -e original_image -u`
  [ -z "$URL" ] && die "$IMG: `echo "$RESP" | jshon -e rsp -e image -e error_msg -u`"

  echo $URL
done
